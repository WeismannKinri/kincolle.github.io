<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java Concurrency - SyncControl | Asahina Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/ok_favicon.ico">
    <meta name="description" content="For Tech Blog">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.167a03c8.css" as="style"><link rel="preload" href="/assets/js/app.b9286d3a.js" as="script"><link rel="preload" href="/assets/js/3.34f284b1.js" as="script"><link rel="preload" href="/assets/js/1.f9d84a83.js" as="script"><link rel="preload" href="/assets/js/93.a57472ec.js" as="script"><link rel="prefetch" href="/assets/js/10.bded442d.js"><link rel="prefetch" href="/assets/js/100.fb4bf34b.js"><link rel="prefetch" href="/assets/js/101.03e7bb16.js"><link rel="prefetch" href="/assets/js/102.4a11ae8b.js"><link rel="prefetch" href="/assets/js/103.5757d761.js"><link rel="prefetch" href="/assets/js/104.be01ea5a.js"><link rel="prefetch" href="/assets/js/105.3e9da9a7.js"><link rel="prefetch" href="/assets/js/106.5c523c0a.js"><link rel="prefetch" href="/assets/js/107.f3ae976c.js"><link rel="prefetch" href="/assets/js/108.3bfc051e.js"><link rel="prefetch" href="/assets/js/109.a950c828.js"><link rel="prefetch" href="/assets/js/11.a30f64dc.js"><link rel="prefetch" href="/assets/js/110.baf94bdd.js"><link rel="prefetch" href="/assets/js/111.d3e82662.js"><link rel="prefetch" href="/assets/js/112.3510c1a5.js"><link rel="prefetch" href="/assets/js/113.490d097d.js"><link rel="prefetch" href="/assets/js/114.86dd7a55.js"><link rel="prefetch" href="/assets/js/115.f9a9de96.js"><link rel="prefetch" href="/assets/js/116.cd589907.js"><link rel="prefetch" href="/assets/js/117.8a557b27.js"><link rel="prefetch" href="/assets/js/118.d7875ce3.js"><link rel="prefetch" href="/assets/js/119.8ec1c8a7.js"><link rel="prefetch" href="/assets/js/12.feeaa64e.js"><link rel="prefetch" href="/assets/js/120.9cebfd29.js"><link rel="prefetch" href="/assets/js/121.758051b6.js"><link rel="prefetch" href="/assets/js/122.6ca0b73d.js"><link rel="prefetch" href="/assets/js/123.61abedfa.js"><link rel="prefetch" href="/assets/js/124.65c45060.js"><link rel="prefetch" href="/assets/js/125.bee1a935.js"><link rel="prefetch" href="/assets/js/126.7a6ba7c1.js"><link rel="prefetch" href="/assets/js/127.25bd1de5.js"><link rel="prefetch" href="/assets/js/128.5fac26f4.js"><link rel="prefetch" href="/assets/js/129.81fe215a.js"><link rel="prefetch" href="/assets/js/13.a583a50f.js"><link rel="prefetch" href="/assets/js/130.b693c1f7.js"><link rel="prefetch" href="/assets/js/131.c1a5f08f.js"><link rel="prefetch" href="/assets/js/132.c003f99b.js"><link rel="prefetch" href="/assets/js/133.dbc2b1d0.js"><link rel="prefetch" href="/assets/js/134.ffb0ba3e.js"><link rel="prefetch" href="/assets/js/135.2a99648b.js"><link rel="prefetch" href="/assets/js/136.d2485008.js"><link rel="prefetch" href="/assets/js/14.4e745b87.js"><link rel="prefetch" href="/assets/js/15.dbce9029.js"><link rel="prefetch" href="/assets/js/16.38f7e50a.js"><link rel="prefetch" href="/assets/js/17.70925bcd.js"><link rel="prefetch" href="/assets/js/18.e46fb508.js"><link rel="prefetch" href="/assets/js/19.6f29c214.js"><link rel="prefetch" href="/assets/js/20.94a9fcfa.js"><link rel="prefetch" href="/assets/js/21.811a31b4.js"><link rel="prefetch" href="/assets/js/22.9635d013.js"><link rel="prefetch" href="/assets/js/23.d91ca7bb.js"><link rel="prefetch" href="/assets/js/24.7594f22e.js"><link rel="prefetch" href="/assets/js/25.5201c039.js"><link rel="prefetch" href="/assets/js/26.a4a414f5.js"><link rel="prefetch" href="/assets/js/27.b2a25a6f.js"><link rel="prefetch" href="/assets/js/28.6b858d38.js"><link rel="prefetch" href="/assets/js/29.3e3dec62.js"><link rel="prefetch" href="/assets/js/30.f43609d7.js"><link rel="prefetch" href="/assets/js/31.c16f710a.js"><link rel="prefetch" href="/assets/js/32.b832c650.js"><link rel="prefetch" href="/assets/js/33.1d674f70.js"><link rel="prefetch" href="/assets/js/34.eec473cf.js"><link rel="prefetch" href="/assets/js/35.45e677f8.js"><link rel="prefetch" href="/assets/js/36.a94855cd.js"><link rel="prefetch" href="/assets/js/37.d5e360f7.js"><link rel="prefetch" href="/assets/js/38.7adacaec.js"><link rel="prefetch" href="/assets/js/39.a8084e1c.js"><link rel="prefetch" href="/assets/js/4.84e5a624.js"><link rel="prefetch" href="/assets/js/40.33f96378.js"><link rel="prefetch" href="/assets/js/41.5f389133.js"><link rel="prefetch" href="/assets/js/42.2ad3e579.js"><link rel="prefetch" href="/assets/js/43.d050b184.js"><link rel="prefetch" href="/assets/js/44.c471dd41.js"><link rel="prefetch" href="/assets/js/45.97d4b625.js"><link rel="prefetch" href="/assets/js/46.1784fe90.js"><link rel="prefetch" href="/assets/js/47.b9a2f153.js"><link rel="prefetch" href="/assets/js/48.c2c08eb4.js"><link rel="prefetch" href="/assets/js/49.12f675e4.js"><link rel="prefetch" href="/assets/js/5.d5aedfcc.js"><link rel="prefetch" href="/assets/js/50.6cb98f62.js"><link rel="prefetch" href="/assets/js/51.5472efd2.js"><link rel="prefetch" href="/assets/js/52.f84a9f29.js"><link rel="prefetch" href="/assets/js/53.ee8e8ce9.js"><link rel="prefetch" href="/assets/js/54.c9880a25.js"><link rel="prefetch" href="/assets/js/55.16066570.js"><link rel="prefetch" href="/assets/js/56.361cb3ce.js"><link rel="prefetch" href="/assets/js/57.34a0d117.js"><link rel="prefetch" href="/assets/js/58.fadfe4b0.js"><link rel="prefetch" href="/assets/js/59.a41f6a99.js"><link rel="prefetch" href="/assets/js/6.5a7cd716.js"><link rel="prefetch" href="/assets/js/60.192e4257.js"><link rel="prefetch" href="/assets/js/61.f1ce6148.js"><link rel="prefetch" href="/assets/js/62.4106766e.js"><link rel="prefetch" href="/assets/js/63.056f81e0.js"><link rel="prefetch" href="/assets/js/64.5794f88a.js"><link rel="prefetch" href="/assets/js/65.7e27f286.js"><link rel="prefetch" href="/assets/js/66.7f775f7a.js"><link rel="prefetch" href="/assets/js/67.845035a8.js"><link rel="prefetch" href="/assets/js/68.3e950c61.js"><link rel="prefetch" href="/assets/js/69.552f1e2a.js"><link rel="prefetch" href="/assets/js/7.17f7bba3.js"><link rel="prefetch" href="/assets/js/70.58b6c7d7.js"><link rel="prefetch" href="/assets/js/71.ab4857ff.js"><link rel="prefetch" href="/assets/js/72.a2b612a3.js"><link rel="prefetch" href="/assets/js/73.33785b5c.js"><link rel="prefetch" href="/assets/js/74.d0e65e27.js"><link rel="prefetch" href="/assets/js/75.656534c7.js"><link rel="prefetch" href="/assets/js/76.9bf1c8f4.js"><link rel="prefetch" href="/assets/js/77.6fe99cb5.js"><link rel="prefetch" href="/assets/js/78.cde5084e.js"><link rel="prefetch" href="/assets/js/79.c041a32e.js"><link rel="prefetch" href="/assets/js/8.46502f9a.js"><link rel="prefetch" href="/assets/js/80.6bb61012.js"><link rel="prefetch" href="/assets/js/81.833ccf58.js"><link rel="prefetch" href="/assets/js/82.78d0b572.js"><link rel="prefetch" href="/assets/js/83.c349571d.js"><link rel="prefetch" href="/assets/js/84.6031de5e.js"><link rel="prefetch" href="/assets/js/85.977a1325.js"><link rel="prefetch" href="/assets/js/86.398dd26a.js"><link rel="prefetch" href="/assets/js/87.0786c918.js"><link rel="prefetch" href="/assets/js/88.8916a562.js"><link rel="prefetch" href="/assets/js/89.e81a766d.js"><link rel="prefetch" href="/assets/js/9.487070f3.js"><link rel="prefetch" href="/assets/js/90.07201893.js"><link rel="prefetch" href="/assets/js/91.87109b84.js"><link rel="prefetch" href="/assets/js/92.533dd006.js"><link rel="prefetch" href="/assets/js/94.4cc02a37.js"><link rel="prefetch" href="/assets/js/95.9b69596f.js"><link rel="prefetch" href="/assets/js/96.5e5a6df7.js"><link rel="prefetch" href="/assets/js/97.da7836fe.js"><link rel="prefetch" href="/assets/js/98.4a01baf8.js"><link rel="prefetch" href="/assets/js/99.8d735511.js">
    <link rel="stylesheet" href="/assets/css/0.styles.167a03c8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-130b300a><div data-v-130b300a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-130b300a data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Asahina Blog</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>For Tech Blog</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>Kincolle</span>
            
          <span data-v-25ba6db2>2020 - </span>
          2022
        </a></span></div></div> <div class="hide" data-v-130b300a><header class="navbar" data-v-130b300a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/logo.jpg" alt="Asahina Blog" class="logo"> <span class="site-name">Asahina Blog</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="undefined"></i>
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/Container/" class="nav-link"><i class="undefined"></i>
  Container
</a></li><li class="dropdown-item"><!----> <a href="/categories/Design Pattern/" class="nav-link"><i class="undefined"></i>
  Design Pattern
</a></li><li class="dropdown-item"><!----> <a href="/categories/Elasticsearch/" class="nav-link"><i class="undefined"></i>
  Elasticsearch
</a></li><li class="dropdown-item"><!----> <a href="/categories/Hive/" class="nav-link"><i class="undefined"></i>
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Lucene/" class="nav-link"><i class="undefined"></i>
  Lucene
</a></li><li class="dropdown-item"><!----> <a href="/categories/Message/" class="nav-link"><i class="undefined"></i>
  Message
</a></li><li class="dropdown-item"><!----> <a href="/categories/Mybatis/" class="nav-link"><i class="undefined"></i>
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/categories/Redis/" class="nav-link"><i class="undefined"></i>
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/categories/Spring/" class="nav-link"><i class="undefined"></i>
  Spring
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tags
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="https://github.com/kincolle" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  My Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-130b300a></div> <aside class="sidebar" data-v-130b300a><div class="personal-info-wrapper" data-v-39576ba9 data-v-130b300a><img src="/avatar.jpg" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    Kincolle
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>126</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>15</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/Algorithm/" class="nav-link"><i class="undefined"></i>
  Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/categories/Container/" class="nav-link"><i class="undefined"></i>
  Container
</a></li><li class="dropdown-item"><!----> <a href="/categories/Design Pattern/" class="nav-link"><i class="undefined"></i>
  Design Pattern
</a></li><li class="dropdown-item"><!----> <a href="/categories/Elasticsearch/" class="nav-link"><i class="undefined"></i>
  Elasticsearch
</a></li><li class="dropdown-item"><!----> <a href="/categories/Hive/" class="nav-link"><i class="undefined"></i>
  Hive
</a></li><li class="dropdown-item"><!----> <a href="/categories/Java/" class="nav-link"><i class="undefined"></i>
  Java
</a></li><li class="dropdown-item"><!----> <a href="/categories/Lucene/" class="nav-link"><i class="undefined"></i>
  Lucene
</a></li><li class="dropdown-item"><!----> <a href="/categories/Message/" class="nav-link"><i class="undefined"></i>
  Message
</a></li><li class="dropdown-item"><!----> <a href="/categories/Mybatis/" class="nav-link"><i class="undefined"></i>
  Mybatis
</a></li><li class="dropdown-item"><!----> <a href="/categories/Redis/" class="nav-link"><i class="undefined"></i>
  Redis
</a></li><li class="dropdown-item"><!----> <a href="/categories/Spring/" class="nav-link"><i class="undefined"></i>
  Spring
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tags
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="https://github.com/kincolle" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  My Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Java Concurrency - SyncControl</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>Kincolle</span>
            
          <span data-v-25ba6db2>2020 - </span>
          2022
        </a></span></div></div> <div data-v-130b300a><main class="page"><section><div class="page-title"><h1 class="title">Java Concurrency - SyncControl</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>Kincolle</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>3/19/2018</span></i> <!----> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>Java Concurrency</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="_1-reenterlock"><a href="#_1-reenterlock" class="header-anchor">#</a> 1 ReenterLock</h2> <p>The ReenterLock can replace synchronized totally. It is implemented in java.util.concurrent.locks.ReentrantLock. Here is a code example of it:</p> <div class="language- extra-class"><pre><code>public class ReenterLock implements Runnable{
    public static ReentrantLock lock = new ReentrantLock();
    public static int i = 0;
    @Override
    public void run() {
        for(int j = 0;j&lt;10000000;j++){
            lock.lock();
            lock.lock();
            try {
                i++;
            }
            finally {
                lock.unlock();
                lock.unlock();
            }

        }
    }

    public static void main(String[] args) throws InterruptedException {
        ReenterLock tl = new ReenterLock();
        Thread t1 = new Thread(tl);
        Thread t2 = new Thread(tl);
        t1.start();
        t2.start();
        t1.join();
        t2.join();
        System.out.println(i);
    }
}
</code></pre></div><p>From the 7th line to 12th line of the code, ReentrantLock is used for protecting i, and it makes sure that operation for i is thread safe. Compare to synchronized, developer should lock and unlock by hinself. That is the reason  flexibility of ReentrantLock is better than that of synchronized. By the way, when using ReentrantLock you must release the lock when you finished your job or the critical section will never be accessed.<br>
You may wonder why it is called ReentrantLock, Because you can lock the same thing more than one time. That is why in the code, the &quot;lock.lock();&quot; and the &quot;lock.unlock();&quot; was used twice.<br></p> <h5 id="interruption"><a href="#interruption" class="header-anchor">#</a> Interruption</h5> <p>In synchronized, if a thread is waiting on a lock, there only 2 results:(1) get the lock it wants; ()keep on waiting. Btt in ReentrantLock, there is a3rd result, that is the interruption. That means while waiting on a lock, the waiting can be canceled. This may be helpful for deadlock. Here is an example of it.</p> <div class="language- extra-class"><pre><code>public class IntLock implements Runnable{
    public static ReentrantLock lock1 = new ReentrantLock();
    public static ReentrantLock lock2 = new ReentrantLock();
    int lock;

    public IntLock(int lock){
        this.lock=lock;
    }

    @Override
    public void run(){
        try{
            if(lock == 1) {
                lock1.lockInterruptibly();
                try {
                    Thread.sleep(500);
                }catch (InterruptedException e){}
                lock2.lockInterruptibly();
            }else {
                lock2.lockInterruptibly();
                try{
                    Thread.sleep(500);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                lock1.lockInterruptibly();
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            if(lock1.isHeldByCurrentThread())
                lock1.unlock();
            if(lock2.isHeldByCurrentThread())
                lock2.unlock();
            System.out.println(Thread.currentThread().getId()+&quot;:the thread is out&quot;);
        }
    }

    public static void main(String[] args) throws InterruptedException {
        IntLock r1 = new IntLock(1);
        IntLock r2 = new IntLock(2);
        Thread t1 = new Thread(r1);
        Thread t2 = new Thread(r2);
        t1.start();
        t2.start();
        Thread.sleep(1000);
        t2.interrupt();
    }
} 
</code></pre></div><p>After t1 and t2 started, t1 takes lock1 then takes lock2; t2 takes lock2 then takes lock1. So, there is a deadlock apparantly. Here, requesting for lock uses lockInterruptible() function. Then, the waiting on lock can be canceled.<br>
At the 47th code, since main thread is sleeping, the 2 threads are in deadlock. At the 49th code, due to t2 is interrupted, t2 will give up waiting on lock1 and release lock2. Then t1 will operate successfully.</p> <h5 id="waiting-time-limit"><a href="#waiting-time-limit" class="header-anchor">#</a> Waiting Time Limit</h5> <p>For avoidiung deadlock, there is a way call Waiting Time Limit. Most time, we can not know why we can't get the lock we want and starvation happens. If giving a Waiting Time Limit and let the thread give up automatically. That is meaningful for system. We can use tryLock() to do a Waiting Time Limit. Here is an example of it。</p> <div class="language- extra-class"><pre><code>public class TimeLock implements Runnable{
    public static ReentrantLock lock = new ReentrantLock();
    @Override
    public void run() {
        try{
            if(lock.tryLock(5, TimeUnit.SECONDS)){
                Thread.sleep(6000);
            }else{
                System.out.println(&quot;get lock failed&quot;);
            }
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            if(lock.isHeldByCurrentThread()) lock.unlock();
        }
    }

    public static void main(String[] args) {
        TimeLock tl = new TimeLock();
        Thread t1 = new Thread(tl);
        Thread t2 = new Thread(tl);
        t1.start();
        t2.start();
    }
}
</code></pre></div><p>Here, tryLock() get 2 parameers:(1) the first one is the length of time (2) another is the time unit we use. Here our time unit is second and the length is 5. It means the thread will waiting on lock at most 5 seconds. If it gets lock successfully in 5 seconds it will return true and return false if not. Here it will waiting for 6 seconds, so it will fail.<br>
ReentrantLock.tryLock() can operate without any parameter. At this situation, the current thread will immediately get lock which is not being taken and return true. If the lock is being taken then do not wait and return false immediately. At this model, there is no deadlock. Here is an example:</p> <div class="language- extra-class"><pre><code> public class TryLock implements Runnable {
    public static ReentrantLock lock1 = new ReentrantLock();
    public static ReentrantLock lock2 = new ReentrantLock();
    int lock;

    public TryLock(int lock){
        this.lock=lock;
    }
    @Override
    public void run() {
        if(lock == 1 ){
            while(true){
                if(lock1.tryLock()){
                    try {
                        try {
                            Thread.sleep(500);
                        } catch (InterruptedException e) {
                            e.printStackTrace();
                        }
                        if(lock2.tryLock()){
                            try {
                                System.out.println(Thread.currentThread().getId()+&quot;:My job done&quot;);
                                return;
                            }finally {
                                lock2.unlock();
                            }
                        }
                    }finally {
                        lock1.unlock();
                    }
                }
            }
        }else {
            while (true){
                if(lock2.tryLock()){
                    try {
                        try {
                            Thread.sleep(500);
                        }catch (InterruptedException e){
                        }
                        if(lock1.tryLock()){
                            try {
                                System.out.println(Thread.currentThread().getId()+&quot;:My job done&quot;);
                                return;
                            }finally {
                                lock1.unlock();
                            }
                        }
                    }finally {
                        lock2.unlock();
                    }
                }
            }
        }
    }

    public static void main(String[] args) {
        TryLock r1 = new TryLock(1);
        TryLock r2 = new TryLock(2);
        Thread t1 = new Thread(r1);
        Thread t2 = new Thread(r2);
        t1.start();
        t2.start();
    }
}
</code></pre></div><p>In the code, t1 and t2 are at deadlock situation. But since tryLock() is used, the they will not waiting forever.</p> <h5 id="fairlock"><a href="#fairlock" class="header-anchor">#</a> FairLock</h5> <p>At the most situation, requesting for lock is not fair. For example, thread 1 requests lock A then thread 2 requests lock A too. When lock A is useful, which one should get the Lock A. System will choose one randomly. So it is not fair. But fairLock is not like this. It will operate in a order: first in first out. That means there will be no starvation. If we use synchornized to control lock, it will be unfair. ReentrantLock can let us set the fairness. Here is the constructor:</p> <div class="language- extra-class"><pre><code>public ReentrantLock(boolean fair)
</code></pre></div><p>When the parameter fair is true, it means the lock is fair. The fairLock looks good, but it needs a ordered queue. So, performance of fairLock is not good. Here is an exmaple of fairLock:</p> <div class="language- extra-class"><pre><code>public class FairLock implements Runnable{
    public static ReentrantLock fairLock = new ReentrantLock(true);
    @Override
    public void run() {
        while (true){
            try{
                fairLock.lock();
                System.out.println(Thread.currentThread().getName()+&quot; get the lock&quot;);
            }finally {
                fairLock.unlock();
            }
        }
    }

    public static void main(String[] args) {
        FairLock fr = new FairLock();
        Thread t1 = new Thread(fr,&quot;t1&quot;);
        Thread t2 = new Thread(fr,&quot;t2&quot;);
        t1.start();
        t2.start();
    }
}
</code></pre></div><p>At the second code, it sets the lock to be fair. Then, there are 2 threads t1 and t2 requesting the lock. Here is the result:</p> <div class="language- extra-class"><pre><code>t1 get the lock
t2 get the lock
t1 get the lock
t2 get the lock
</code></pre></div><p>Here we can see it is ordered.</p> <p>About ReentrantLock, here is some points:</p> <ul><li>lock(): request lock, if the lock is being taken then wait</li> <li>lockInterruptibly(): request lock, but interruption first.</li> <li>tryLock(): try to get lock, return true if succeeds and false if fails immediately</li> <li>tryLock(longt time, TimeUnit unit): try to get lock, return true if succeeds and false if fails in the limit time</li> <li>unlock(): release lock</li></ul> <h2 id="_2-condition"><a href="#_2-condition" class="header-anchor">#</a> 2 Condition</h2> <p>I have introduced Object.wait() and Object.notify(), Condition object is like them. Object.wait() and Object.notify() is always used with sycnchronized. But Condition is always used with ReentrantLock. Through &quot;Condition newCondition()&quot; of Lock interface we can create a ReentrantLock with Condition.<br>
There are some functions of Condition I want to introduce:</p> <ul><li>await(): it will let then current thread wait and release the lock the current thread has taken. When other threads use signal() or signalAll(), it will go on.</li> <li>awaitUninterruptibly(): It is like await() and will not be interrupted.</li> <li>signal(): it will signal one thread. It is like Object.notify().</li></ul> <p>Here is an example of it:</p> <div class="language- extra-class"><pre><code>public class ReenterLockCondition implements Runnable{
    public static ReentrantLock lock = new ReentrantLock();
    public static Condition condition = lock.newCondition();
    @Override
    public void run() {
        try{
            lock.lock();
            condition.await();
            System.out.println(&quot;Thread is going on&quot;);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally {
            lock.unlock();
        }
    }

    public static void main(String[] args) throws InterruptedException {
        ReenterLockCondition tl = new ReenterLockCondition();
        Thread t1 = new Thread(tl);
        t1.start();
        Thread.sleep(200);

        lock.lock();
        condition.signal();
        System.out.println(&quot;before unlock the lock&quot;);
        lock.unlock();
        System.out.println(&quot;after unlock the lock&quot;);
    }
}
</code></pre></div><p>At the 3rd line of the code, it create a Contition instance. At the 8th line of the code, request Condition object to wait.</p> <h2 id="_3-semaphore"><a href="#_3-semaphore" class="header-anchor">#</a> 3 Semaphore</h2> <p>The semaphore is used for cooperation of threads. It is extension of Lock. Both synchronized and ReentrantLock only allow one request succeed to get the resource. But the semaphore can allow more than one thread to access one resource. Here is the constructor of semaphore:</p> <div class="language- extra-class"><pre><code>public Semaphore(int permits)
public Semaphore(int permits, boolean fair)
</code></pre></div><p>When constructs a semaphore, must input the number of thread that can be allowed.<br>
Here is a example of semaphore:</p> <div class="language- extra-class"><pre><code>public class SemapDemo implements  Runnable{
    final Semaphore semp = new Semaphore(5);
    @Override
    public void run() {
        try{
            semp.acquire();

            Thread.sleep(2000);
            System.out.println(Thread.currentThread().getId()+&quot;:done&quot;);
            semp.release();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }

    public static void main(String[] args) {
        ExecutorService exec = Executors.newFixedThreadPool(20);
        final SemapDemo demo = new SemapDemo();
        for(int i=0;i&lt;20;i++){
            exec.submit(demo);
        }
    }
}
</code></pre></div><p>From the 7th line to the 9th line of the code is the critical section code, program will limit the number of threads. At the 2nd line of the code set 5. That means 5 threads can go into the critical section code at the same time. Requesting semaphore is using acquire() and releasing semaphore is using release(). It is the same logic of lock.</p> <h2 id="_4-readwritelock"><a href="#_4-readwritelock" class="header-anchor">#</a> 4 ReadWriteLock</h2> <p>ReadWriteLock is a lock that it can split read and write. It will reduce the competition for resources and advance performance of system. It is easy to understand, like, A1, A2, A3 want to write, and B1, B2, B3 want to read. If  using synchronized or ReentrantLock, theoretically ReadAndRead, ReadAndWrite, WriteAndWrite is serialization operation. When B1 read data, B2 and B3 must wait. But reading do not change data, so it is not unreasonable. That is why ReadWriteLock has been made.<br>
Here is the rules:</p> <ul><li>read-read: do not block</li> <li>read-write: read block write, write will block read too</li> <li>write-write: block</li></ul> <p>In the system, if number of reading is larger than that of writing, then using ReadWriteLock will be helpful. Here is an example:</p> <div class="language- extra-class"><pre><code>public class ReadWriteLockDemo {
    private static Lock lock = new ReentrantLock();
    private static ReentrantReadWriteLock readWriteLock =new ReentrantReadWriteLock();
    private static Lock readLock =readWriteLock.readLock();
    private static Lock writeLock = readWriteLock.writeLock();
    private int value;

    public Object handleRead(Lock lock) throws InterruptedException{
        try{
            lock.lock();
            Thread.sleep(1000);
            return value;
        }finally {
            lock.unlock();
        }
    }

    public void handleWrite(Lock lock,int index) throws InterruptedException{
        try {
            lock.lock();
            Thread.sleep(1000);
            value=index;
        }finally {
            lock.unlock();
        }
    }

    public static void main(String[] args) {
        final ReadWriteLockDemo demo = new ReadWriteLockDemo();
        Runnable readRunnable = new Runnable() {
            @Override
            public void run() {
                try{
                    demo.handleRead(readLock);
                    demo.handleRead(lock);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        };
        Runnable writuRunnable = new Runnable() {
            @Override
            public void run() {
                try{
                    demo.handleWrite(writeLock,new Random().nextInt());
                    demo.handleWrite(lock,new Random().nextInt());
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        };

        for(int i=0;i&lt;18;i++){
            new Thread(readRunnable).start();
        }

        for (int i = 18; i&lt;20;i++){
            new Thread(writuRunnable).start();
        }
    }
}
</code></pre></div><p>At the 11th line and 21 line of code simulate a low performance operating. They are reading and writing. At the 34th line and 45 line of code are the read thread and the write thread. Here, At the 34th line use readLock and At the 35th line writeLock. From 53th to 55th lines, create 18 read threads and from 57th to 59th lines create  2 write threads. Due to using ReadWriteLock, so the reading is parallel and write will be blocked. So the code will finish in about 2 seconds.</p> <h2 id="_5-countdownlatch"><a href="#_5-countdownlatch" class="header-anchor">#</a> 5 CountDownLatch</h2> <p>The CountDownLatch can let a thread do not operate until a count is over. Here is an example of it.</p> <div class="language- extra-class"><pre><code>public class CountDownLatchDemo implements Runnable {
    static final CountDownLatch end = new CountDownLatch(10);
    static final CountDownLatchDemo demo = new CountDownLatchDemo();

    @Override
    public void run() {
        try{

            Thread.sleep(new Random().nextInt(10)*1000);
            System.out.println(&quot;check complete&quot;);
            end.countDown();
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
    }
    public static void main(String[] args) throws InterruptedException {
        ExecutorService exec  = Executors.newFixedThreadPool(10);
        for(int i=0;i&lt;10;i++){
            exec.submit(demo);
        }

        end.await();

        System.out.println(&quot;fire&quot;);
        exec.shutdown();
    }
}
</code></pre></div><p>At the 2nd line of the code, create a CountDownLatch instance. The count number is 10. That means only when 10 threads finished, thread on the CountDownLatch can start to operate.</p> <h2 id="_6-cyclicbarrier"><a href="#_6-cyclicbarrier" class="header-anchor">#</a> 6 CyclicBarrier</h2> <p>The CyclicBarrier is like CountDownLatch but it is more powerful and complex than CountDownLatch. It can be used for more than one time and that is what cyclic means.<br>
Here is an example of it:</p> <div class="language- extra-class"><pre><code>public class CyclicBarrierDemo {
    public static class Soldier implements Runnable{
        private String soldier;
        private final CyclicBarrier cyclic;

        Soldier(CyclicBarrier cyclic, String soldierName){
            this.cyclic=cyclic;
            this.soldier=soldierName;
        }

        @Override
        public void run() {
            try {
                //wait for all soldiers
                cyclic.await();
                doWork();
				//wait for all soldiers finish work
				cyclic.await();
            } catch (InterruptedException e) {
                e.printStackTrace();
            } catch (BrokenBarrierException e) {
                e.printStackTrace();
            }
        }

        void doWork(){
            try {
                Thread.sleep(Math.abs(new Random().nextInt()%10000));
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(soldier+&quot;:mission completed&quot;);
        }
    }

    public static class BarrierRun implements Runnable{
        boolean flag;
        int N;
        public BarrierRun(Boolean flag,int N){
            this.flag=flag;
            this.N=N;
        }

        @Override
        public void run() {
            if(flag){
                System.out.println(&quot;Commander:&quot;+N+&quot;soldiers are mission completed&quot;);
            }else{
                System.out.println(&quot;Commander:&quot;+N+&quot;soldiers are assembled&quot;);
                flag=true;
            }
        }
    }

    public static void main(String[] args) {
        final int N=10;
        Thread[] allSoldier = new Thread[N];
        boolean flag =false;
        CyclicBarrier cyclic = new CyclicBarrier(N,new BarrierRun(flag,N));
		//set the barrier point
        System.out.println(&quot;assemble&quot;);
        for(int i = 0 ; i&lt;N;++i){
            System.out.println(N+&quot;th soldier report&quot;);
            allSoldier[i]=new Thread(new Soldier(cyclic,&quot;soldier&quot;+i));
            allSoldier[i].start();
        }
    }
}
</code></pre></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">4/10/2022, 10:47:25 PM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/views/JavaConcurrency/Concurrency-Java-SyncControl.html#_1-reenterlock" class="sidebar-link reco-side-_1-reenterlock" data-v-cb1513f6>1 ReenterLock</a></li><li class="level-2" data-v-cb1513f6><a href="/views/JavaConcurrency/Concurrency-Java-SyncControl.html#_2-condition" class="sidebar-link reco-side-_2-condition" data-v-cb1513f6>2 Condition</a></li><li class="level-2" data-v-cb1513f6><a href="/views/JavaConcurrency/Concurrency-Java-SyncControl.html#_3-semaphore" class="sidebar-link reco-side-_3-semaphore" data-v-cb1513f6>3 Semaphore</a></li><li class="level-2" data-v-cb1513f6><a href="/views/JavaConcurrency/Concurrency-Java-SyncControl.html#_4-readwritelock" class="sidebar-link reco-side-_4-readwritelock" data-v-cb1513f6>4 ReadWriteLock</a></li><li class="level-2" data-v-cb1513f6><a href="/views/JavaConcurrency/Concurrency-Java-SyncControl.html#_5-countdownlatch" class="sidebar-link reco-side-_5-countdownlatch" data-v-cb1513f6>5 CountDownLatch</a></li><li class="level-2" data-v-cb1513f6><a href="/views/JavaConcurrency/Concurrency-Java-SyncControl.html#_6-cyclicbarrier" class="sidebar-link reco-side-_6-cyclicbarrier" data-v-cb1513f6>6 CyclicBarrier</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      欢迎来到 Asahina Blog
    </div> <div class="operation" style="right:90px;bottom:40px;display:none;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:none;" data-v-5775ee02></i></div> <canvas id="banniang" width="200" height="320" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><div class="reco-bgm-panel" data-v-b1d3339e><audio id="bgm" src="/bgm/紅蓮華.mp3" data-v-b1d3339e></audio> <div class="reco-float-box" style="bottom:200px;z-index:999999;display:none;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><img src="/bgm/紅蓮華.jpg" data-v-b1d3339e></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="reco-bgm-cover" style="background-image:url(/bgm/紅蓮華.jpg);" data-v-b1d3339e><div class="mini-operation" style="display:none;" data-v-b1d3339e><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-b1d3339e></i></div> <div class="falut-message" style="display:none;" data-v-b1d3339e>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-music music" data-v-b1d3339e></i>紅蓮華</div> <div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-artist" data-v-b1d3339e></i>Lisa</div> <div class="reco-bgm-progress" data-v-b1d3339e><div class="progress-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div> <div class="reco-bgm-operation" data-v-b1d3339e><i class="reco-bgm reco-bgm-last last" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play play" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-next next" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-b1d3339e></i> <div class="volume-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div></div> <div class="reco-bgm-left-box" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><i class="reco-bgm reco-bgm-left" data-v-b1d3339e></i></div></div></div><canvas id="vuepress-canvas-cursor"></canvas><div></div><div id="goTop" class="hide-cat" data-v-bf92849a></div></div></div>
    <script src="/assets/js/app.b9286d3a.js" defer></script><script src="/assets/js/3.34f284b1.js" defer></script><script src="/assets/js/1.f9d84a83.js" defer></script><script src="/assets/js/93.a57472ec.js" defer></script>
  </body>
</html>
